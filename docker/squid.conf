# =============================================================================
# Squid Proxy Configuration - OpenClaw Stack
# Version: 1.0.0
# Auteur: Ethan Bernier (ORCID: 0009-0008-9839-5763)
# Description: Proxy avec whitelist stricte pour accès internet contrôlé
# =============================================================================
#
# PHILOSOPHIE :
# - DENY ALL par défaut
# - Seuls les domaines explicitement listés sont accessibles
# - Pas d'accès direct à Internet depuis les containers
#
# DOMAINES AUTORISÉS :
# - APIs LLM (Anthropic, OpenAI, Google)
# - Moteurs de recherche (DuckDuckGo, Brave)
# - Documentation technique (GitHub, MDN, etc.)
# - Registres de packages (npm, PyPI)
# - Hugging Face (modèles)
#
# =============================================================================

# -----------------------------------------------------------------------------
# Configuration de base
# -----------------------------------------------------------------------------
http_port 3128
visible_hostname squid-proxy.openclaw.local

# PID et cache
pid_filename /var/run/squid/squid.pid
coredump_dir /var/spool/squid

# -----------------------------------------------------------------------------
# ACL - Access Control Lists
# -----------------------------------------------------------------------------

# Ports autorisés
acl SSL_ports port 443
acl Safe_ports port 80          # HTTP
acl Safe_ports port 443         # HTTPS
acl CONNECT method CONNECT

# Méthodes HTTP autorisées
acl safe_methods method GET HEAD POST PUT PATCH DELETE OPTIONS

# Réseau local Docker
acl localnet src 10.0.0.0/8
acl localnet src 172.16.0.0/12
acl localnet src 192.168.0.0/16
acl localnet src fc00::/7
acl localnet src fe80::/10

# Localhost
acl localhost src 127.0.0.0/8
acl localhost src ::1/128

# -----------------------------------------------------------------------------
# WHITELIST - Domaines autorisés UNIQUEMENT
# -----------------------------------------------------------------------------

# ===== APIs LLM Cloud =====
# Anthropic (Claude)
acl whitelist_llm dstdomain .anthropic.com
acl whitelist_llm dstdomain api.anthropic.com

# OpenAI (GPT)
acl whitelist_llm dstdomain .openai.com
acl whitelist_llm dstdomain api.openai.com

# Google AI (Gemini)
acl whitelist_llm dstdomain .googleapis.com
acl whitelist_llm dstdomain generativelanguage.googleapis.com

# Azure OpenAI
acl whitelist_llm dstdomain .azure.com
acl whitelist_llm dstdomain .openai.azure.com

# Mistral AI
acl whitelist_llm dstdomain .mistral.ai
acl whitelist_llm dstdomain api.mistral.ai

# Cohere
acl whitelist_llm dstdomain .cohere.ai
acl whitelist_llm dstdomain api.cohere.ai

# ===== Recherche Web (pour l'outil web_search) =====
acl whitelist_search dstdomain .duckduckgo.com
acl whitelist_search dstdomain duckduckgo.com
acl whitelist_search dstdomain .searx.org
acl whitelist_search dstdomain searx.be
acl whitelist_search dstdomain .brave.com
acl whitelist_search dstdomain search.brave.com

# ===== Documentation technique =====
# GitHub
acl whitelist_docs dstdomain .github.com
acl whitelist_docs dstdomain github.com
acl whitelist_docs dstdomain .githubusercontent.com
acl whitelist_docs dstdomain raw.githubusercontent.com
acl whitelist_docs dstdomain gist.github.com
acl whitelist_docs dstdomain api.github.com

# GitLab
acl whitelist_docs dstdomain .gitlab.com
acl whitelist_docs dstdomain gitlab.com

# MDN (Mozilla Developer Network)
acl whitelist_docs dstdomain developer.mozilla.org

# Stack Overflow
acl whitelist_docs dstdomain .stackoverflow.com
acl whitelist_docs dstdomain stackoverflow.com
acl whitelist_docs dstdomain .stackexchange.com

# ReadTheDocs
acl whitelist_docs dstdomain .readthedocs.io
acl whitelist_docs dstdomain .readthedocs.org

# Python docs
acl whitelist_docs dstdomain docs.python.org

# Node.js docs
acl whitelist_docs dstdomain nodejs.org

# Kubernetes docs
acl whitelist_docs dstdomain kubernetes.io

# Docker docs
acl whitelist_docs dstdomain docs.docker.com

# ===== Registres de packages =====
# npm
acl whitelist_registry dstdomain registry.npmjs.org
acl whitelist_registry dstdomain .npmjs.org
acl whitelist_registry dstdomain .npmjs.com

# PyPI
acl whitelist_registry dstdomain pypi.org
acl whitelist_registry dstdomain pypi.python.org
acl whitelist_registry dstdomain files.pythonhosted.org

# Cargo (Rust)
acl whitelist_registry dstdomain crates.io
acl whitelist_registry dstdomain static.crates.io

# ===== Hugging Face (modèles) =====
acl whitelist_hf dstdomain .huggingface.co
acl whitelist_hf dstdomain huggingface.co
acl whitelist_hf dstdomain cdn-lfs.huggingface.co
acl whitelist_hf dstdomain cdn-lfs-us-1.huggingface.co

# ===== OpenClaw officiel =====
acl whitelist_openclaw dstdomain .openclaw.ai
acl whitelist_openclaw dstdomain openclaw.ai
acl whitelist_openclaw dstdomain docs.openclaw.ai
acl whitelist_openclaw dstdomain api.openclaw.ai

# ===== Certificats & Sécurité =====
acl whitelist_security dstdomain .digicert.com
acl whitelist_security dstdomain .letsencrypt.org
acl whitelist_security dstdomain ocsp.pki.goog

# -----------------------------------------------------------------------------
# Règles d'accès (ORDRE IMPORTANT !)
# -----------------------------------------------------------------------------

# 1. Interdire les ports non sécurisés
http_access deny !Safe_ports

# 2. Interdire CONNECT sur ports non-SSL
http_access deny CONNECT !SSL_ports

# 3. Autoriser localhost
http_access allow localhost

# 4. Autoriser le réseau local Docker
http_access allow localnet

# 5. Autoriser UNIQUEMENT les domaines en whitelist
http_access allow whitelist_llm
http_access allow whitelist_search
http_access allow whitelist_docs
http_access allow whitelist_registry
http_access allow whitelist_hf
http_access allow whitelist_openclaw
http_access allow whitelist_security

# 6. BLOQUER TOUT LE RESTE (IMPORTANT !)
http_access deny all

# -----------------------------------------------------------------------------
# Cache Configuration
# -----------------------------------------------------------------------------
cache_mem 256 MB
maximum_object_size_in_memory 1 MB

# Cache disque (1 Go, structure 16/256)
cache_dir ufs /var/spool/squid 1000 16 256
maximum_object_size 100 MB
minimum_object_size 0 KB

# Cache des requêtes négatives
negative_ttl 5 minutes

# -----------------------------------------------------------------------------
# Logging
# -----------------------------------------------------------------------------

# Logs d'accès
access_log daemon:/var/log/squid/access.log squid

# Logs du cache
cache_log /var/log/squid/cache.log

# Pas de logs de store (économie disque)
cache_store_log none

# Format de log personnalisé pour analyse
logformat openclaw %ts.%03tu %6tr %>a %Ss/%03>Hs %<st %rm %ru %[un %Sh/%<a %mt "%{User-Agent}>h"

# Rotation des logs
logfile_rotate 7

# -----------------------------------------------------------------------------
# Sécurité
# -----------------------------------------------------------------------------

# Cacher la version Squid
httpd_suppress_version_string on

# Désactiver les headers révélateurs
via off
forwarded_for delete

# Supprimer les headers sensibles
request_header_access X-Forwarded-For deny all
request_header_access Via deny all
request_header_access Proxy-Connection deny all
request_header_access Cache-Control deny all

# Ne pas envoyer de header Server
reply_header_access Server deny all
reply_header_access X-Squid-Error deny all

# -----------------------------------------------------------------------------
# Timeouts
# -----------------------------------------------------------------------------
connect_timeout 30 seconds
read_timeout 60 seconds
request_timeout 60 seconds
client_lifetime 1 day
pconn_timeout 1 minute

# -----------------------------------------------------------------------------
# Limites de connexion
# -----------------------------------------------------------------------------
client_db on
max_filedescriptors 4096

# Limiter les connexions par client
# acl maxconn_client maxconn 10
# http_access deny maxconn_client

# -----------------------------------------------------------------------------
# DNS
# -----------------------------------------------------------------------------
# Utiliser les DNS publics sécurisés
dns_nameservers 1.1.1.1 8.8.8.8 9.9.9.9

# TTL DNS
positive_dns_ttl 6 hours
negative_dns_ttl 1 minute

# -----------------------------------------------------------------------------
# Refresh Patterns
# -----------------------------------------------------------------------------
# FTP
refresh_pattern ^ftp:           1440    20%     10080

# Gopher (obsolète mais au cas où)
refresh_pattern ^gopher:        1440    0%      1440

# CGI / Dynamique - pas de cache
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0

# GitHub raw content
refresh_pattern githubusercontent.com 60 50% 1440

# npm registry
refresh_pattern registry.npmjs.org 60 50% 1440

# PyPI
refresh_pattern pypi.org 60 50% 1440

# Default
refresh_pattern .               0       20%     4320

# -----------------------------------------------------------------------------
# Shutdown
# -----------------------------------------------------------------------------
shutdown_lifetime 10 seconds

# -----------------------------------------------------------------------------
# Debugging (désactiver en production)
# -----------------------------------------------------------------------------
# debug_options ALL,1
# debug_options 28,9    # Access control
# debug_options 33,2    # Client-side

# =============================================================================
# NOTES
# =============================================================================
#
# Pour ajouter un domaine à la whitelist :
# 1. Ajouter une ligne : acl whitelist_xxx dstdomain .nouveaudomaine.com
# 2. Ajouter la règle : http_access allow whitelist_xxx
# 3. Recharger Squid : squid -k reconfigure
#
# Pour vérifier la config :
#   squid -k parse
#
# Pour voir les connexions en temps réel :
#   tail -f /var/log/squid/access.log
#
# Pour vérifier si un domaine est bloqué :
#   curl -x http://localhost:3128 https://example.com
#   # Si bloqué : 403 Forbidden
#
# =============================================================================
