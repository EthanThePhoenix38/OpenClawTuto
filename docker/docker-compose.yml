# =============================================================================
# Phoenix Docker Compose ‚Äî Multi-Profile Ultra-Secure
# Version: 2.0.0
# Auteur: Ethan Bernier (ORCID: 0009-0008-9839-5763)
# Date: 2026-02-13
# Description: Stack multi-profil (local / k3d / koyeb) post-CVE-2026-25253
# =============================================================================
#
# PROFILS DISPONIBLES :
#
#   üè† local  ‚Üí Docker seul, LLM locaux, pas de proxy, usage personnel
#   üõ°Ô∏è k3d    ‚Üí Docker + Squid proxy (whitelist), monitoring, Zero-Trust
#   ‚òÅÔ∏è  koyeb  ‚Üí Cloud-ready, API keys obligatoires, pas de LLM local
#
# INSTALLATION ONE-CLICK :
#   ./scripts/setup.sh      # Onboarding interactif ‚Üí g√©n√®re .env + lance le bon profil
#
# USAGE MANUEL :
#   docker compose --profile local up -d       # Mode local
#   docker compose --profile k3d up -d         # Mode k3d (avec proxy + monitoring)
#   docker compose --profile koyeb up -d       # Mode cloud
#
# COMMANDES UTILES :
#   docker compose logs -f phoenix            # Logs en temps r√©el
#   docker compose ps                          # √âtat des services
#   docker compose down                        # Arr√™ter
#   docker compose down -v                     # Arr√™ter + supprimer volumes
#
# PR√âREQUIS :
#   - Docker Desktop 4.25+ (Mac/Windows) ou Docker Engine 24+ (Linux)
#   - 8 Go RAM minimum allou√©s √† Docker
#   - [local/k3d] Ollama install√© NATIVEMENT sur le host
#   - [koyeb] Cl√© API Anthropic ou OpenAI
#
# S√âCURIT√â :
#   - Image >= 2026.1.29 (patch CVE-2026-25253)
#   - Token d'auth gateway obligatoire
#   - Non-root, cap_drop ALL, no-new-privileges
#   - PID limit (anti fork-bomb)
#   - Filesystem read-only + tmpfs cibl√©s
#   - mDNS d√©sactiv√©, Control UI s√©curis√©
#   - [k3d] Proxy Squid whitelist stricte
#
# =============================================================================

name: phoenix-stack

# =============================================================================
# SERVICES
# =============================================================================
services:

  # ---------------------------------------------------------------------------
  # Phoenix Gateway ‚Äî Mode LOCAL (Docker simple, LLM locaux, pas de proxy)
  # ---------------------------------------------------------------------------
  phoenix-local:
    image: ghcr.io/phoenix/phoenix:2026.1.30
    container_name: phoenix
    hostname: phoenix
    profiles:
      - local

    restart: unless-stopped

    # Bind sur localhost uniquement (s√©curit√©)
    ports:
      - "127.0.0.1:18789:18789"

    environment:
      # --- Core ---
      - NODE_ENV=production
      - PHOENIX_PORT=18789
      - PHOENIX_HOST=0.0.0.0
      - TZ=${TZ:-Europe/Paris}
      # --- S√©curit√© (post-CVE-2026-25253) ---
      - PHOENIX_SANDBOX_MODE=${PHOENIX_SANDBOX_MODE:-non-main}
      - PHOENIX_DM_ACCESS=${PHOENIX_DM_ACCESS:-pairing}
      - PHOENIX_AUTH_MODE=${PHOENIX_AUTH_MODE:-token}
      - PHOENIX_GATEWAY_TOKEN=${PHOENIX_GATEWAY_TOKEN:?‚ö†Ô∏è  PHOENIX_GATEWAY_TOKEN est obligatoire ‚Äî openssl rand -hex 32}
      - PHOENIX_MDNS_MODE=${PHOENIX_MDNS_MODE:-off}
      - PHOENIX_CONTROL_UI_INSECURE_AUTH=${PHOENIX_CONTROL_UI_INSECURE_AUTH:-false}
      - PHOENIX_SANDBOX_SCOPE=${PHOENIX_SANDBOX_SCOPE:-agent}
      - PHOENIX_LOG_LEVEL=${PHOENIX_LOG_LEVEL:-info}
      # --- LLM locaux ---
      - OLLAMA_HOST=${OLLAMA_HOST:-http://host.docker.internal:11434}
      - LM_STUDIO_HOST=${LM_STUDIO_HOST:-http://host.docker.internal:1234}
      # --- API Keys (optionnelles en local) ---
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - GOOGLE_AI_API_KEY=${GOOGLE_AI_API_KEY:-}
      - MISTRAL_API_KEY=${MISTRAL_API_KEY:-}

    volumes:
      - phoenix-data:/home/phoenix/.phoenix
      - phoenix-logs:/var/log/phoenix
      - type: tmpfs
        target: /tmp
        tmpfs:
          size: ${PHOENIX_TMPFS_SIZE:-1073741824}

    # --- S√©curit√© container ---
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /home/phoenix/.phoenix:uid=1000,gid=1000
    user: "1000:1000"
    pids_limit: ${PHOENIX_PIDS_LIMIT:-256}

    # --- Ressources ---
    deploy:
      resources:
        limits:
          cpus: "${PHOENIX_CPU_LIMIT:-2}"
          memory: ${PHOENIX_MEM_LIMIT:-2G}
        reservations:
          cpus: "${PHOENIX_CPU_RESERVATION:-0.5}"
          memory: ${PHOENIX_MEM_RESERVATION:-512M}

    # --- Health check ---
    healthcheck:
      test: [ "CMD", "curl", "-sf", "http://localhost:18789/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    networks:
      - phoenix-network

    labels:
      - "com.phoenix.service=gateway"
      - "com.phoenix.profile=local"
      - "com.phoenix.version=2026.1.30"
      - "com.phoenix.security=hardened"

  # ---------------------------------------------------------------------------
  # Phoenix Gateway ‚Äî Mode K3D (Zero-Trust, proxy Squid, monitoring)
  # ---------------------------------------------------------------------------
  phoenix-k3d:
    image: ghcr.io/phoenix/phoenix:2026.1.30
    container_name: phoenix
    hostname: phoenix
    profiles:
      - k3d

    restart: unless-stopped

    # Bind sur localhost uniquement
    ports:
      - "127.0.0.1:18789:18789"

    environment:
      # --- Core ---
      - NODE_ENV=production
      - PHOENIX_PORT=18789
      - PHOENIX_HOST=0.0.0.0
      - TZ=${TZ:-Europe/Paris}
      # --- S√©curit√© (post-CVE-2026-25253) ---
      - PHOENIX_SANDBOX_MODE=${PHOENIX_SANDBOX_MODE:-non-main}
      - PHOENIX_DM_ACCESS=${PHOENIX_DM_ACCESS:-pairing}
      - PHOENIX_AUTH_MODE=${PHOENIX_AUTH_MODE:-token}
      - PHOENIX_GATEWAY_TOKEN=${PHOENIX_GATEWAY_TOKEN:?‚ö†Ô∏è  PHOENIX_GATEWAY_TOKEN est obligatoire ‚Äî openssl rand -hex 32}
      - PHOENIX_MDNS_MODE=${PHOENIX_MDNS_MODE:-off}
      - PHOENIX_CONTROL_UI_INSECURE_AUTH=${PHOENIX_CONTROL_UI_INSECURE_AUTH:-false}
      - PHOENIX_SANDBOX_SCOPE=${PHOENIX_SANDBOX_SCOPE:-agent}
      - PHOENIX_LOG_LEVEL=${PHOENIX_LOG_LEVEL:-info}
      # --- LLM locaux ---
      - OLLAMA_HOST=${OLLAMA_HOST:-http://host.docker.internal:11434}
      - LM_STUDIO_HOST=${LM_STUDIO_HOST:-http://host.docker.internal:1234}
      # --- Proxy Squid (tout le trafic sortant passe par l√†) ---
      - HTTP_PROXY=http://squid:3128
      - HTTPS_PROXY=http://squid:3128
      - NO_PROXY=localhost,127.0.0.1,host.docker.internal,ollama
      # --- API Keys ---
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - GOOGLE_AI_API_KEY=${GOOGLE_AI_API_KEY:-}
      - MISTRAL_API_KEY=${MISTRAL_API_KEY:-}

    volumes:
      - phoenix-data:/home/phoenix/.phoenix
      - phoenix-logs:/var/log/phoenix
      - type: tmpfs
        target: /tmp
        tmpfs:
          size: ${PHOENIX_TMPFS_SIZE:-1073741824}

    # --- S√©curit√© container ---
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /home/phoenix/.phoenix:uid=1000,gid=1000
    user: "1000:1000"
    pids_limit: ${PHOENIX_PIDS_LIMIT:-256}

    # --- Ressources ---
    deploy:
      resources:
        limits:
          cpus: "${PHOENIX_CPU_LIMIT:-2}"
          memory: ${PHOENIX_MEM_LIMIT:-2G}
        reservations:
          cpus: "${PHOENIX_CPU_RESERVATION:-0.5}"
          memory: ${PHOENIX_MEM_RESERVATION:-512M}

    # --- Health check ---
    healthcheck:
      test: [ "CMD", "curl", "-sf", "http://localhost:18789/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    # --- D√©pendances ---
    depends_on:
      squid:
        condition: service_healthy

    networks:
      - phoenix-network

    labels:
      - "com.phoenix.service=gateway"
      - "com.phoenix.profile=k3d"
      - "com.phoenix.version=2026.1.30"
      - "com.phoenix.security=zero-trust"

  # ---------------------------------------------------------------------------
  # Phoenix Gateway ‚Äî Mode KOYEB (cloud, pas de LLM local)
  # ---------------------------------------------------------------------------
  phoenix-koyeb:
    image: ghcr.io/phoenix/phoenix:2026.1.30
    container_name: phoenix
    hostname: phoenix
    profiles:
      - koyeb

    restart: unless-stopped

    # Koyeb g√®re le networking ‚Äî bind sur toutes les interfaces
    ports:
      - "18789:18789"

    environment:
      # --- Core ---
      - NODE_ENV=production
      - PHOENIX_PORT=18789
      - PHOENIX_HOST=0.0.0.0
      - TZ=${TZ:-Europe/Paris}
      # --- S√©curit√© (post-CVE-2026-25253) ---
      - PHOENIX_SANDBOX_MODE=${PHOENIX_SANDBOX_MODE:-non-main}
      - PHOENIX_DM_ACCESS=${PHOENIX_DM_ACCESS:-pairing}
      - PHOENIX_AUTH_MODE=${PHOENIX_AUTH_MODE:-token}
      - PHOENIX_GATEWAY_TOKEN=${PHOENIX_GATEWAY_TOKEN:?‚ö†Ô∏è  PHOENIX_GATEWAY_TOKEN est obligatoire ‚Äî openssl rand -hex 32}
      - PHOENIX_MDNS_MODE=${PHOENIX_MDNS_MODE:-off}
      - PHOENIX_CONTROL_UI_INSECURE_AUTH=${PHOENIX_CONTROL_UI_INSECURE_AUTH:-false}
      - PHOENIX_SANDBOX_SCOPE=${PHOENIX_SANDBOX_SCOPE:-agent}
      - PHOENIX_LOG_LEVEL=${PHOENIX_LOG_LEVEL:-info}
      # --- API Keys (OBLIGATOIRES en cloud) ---
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:?‚ö†Ô∏è  Au moins une cl√© API est requise en mode koyeb}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - GOOGLE_AI_API_KEY=${GOOGLE_AI_API_KEY:-}
      - MISTRAL_API_KEY=${MISTRAL_API_KEY:-}
      # ‚ö†Ô∏è  Pas de OLLAMA_HOST / LM_STUDIO_HOST (inaccessibles depuis le cloud)
      # ‚ö†Ô∏è  Pas de HTTP_PROXY (pas de Squid en cloud)

    volumes:
      - phoenix-data:/home/phoenix/.phoenix
      - phoenix-logs:/var/log/phoenix
      - type: tmpfs
        target: /tmp
        tmpfs:
          size: ${PHOENIX_TMPFS_SIZE:-1073741824}

    # --- S√©curit√© container ---
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /home/phoenix/.phoenix:uid=1000,gid=1000
    user: "1000:1000"
    pids_limit: ${PHOENIX_PIDS_LIMIT:-256}

    # --- Ressources ---
    deploy:
      resources:
        limits:
          cpus: "${PHOENIX_CPU_LIMIT:-2}"
          memory: ${PHOENIX_MEM_LIMIT:-2G}
        reservations:
          cpus: "${PHOENIX_CPU_RESERVATION:-0.5}"
          memory: ${PHOENIX_MEM_RESERVATION:-512M}

    # --- Health check ---
    healthcheck:
      test: [ "CMD", "curl", "-sf", "http://localhost:18789/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    networks:
      - phoenix-network

    labels:
      - "com.phoenix.service=gateway"
      - "com.phoenix.profile=koyeb"
      - "com.phoenix.version=2026.1.30"
      - "com.phoenix.security=cloud-hardened"

  # ---------------------------------------------------------------------------
  # Squid Proxy ‚Äî Whitelist internet (k3d uniquement)
  # ---------------------------------------------------------------------------
  squid:
    image: ubuntu/squid:5.7-23.04_beta
    container_name: squid-proxy
    hostname: squid
    profiles:
      - k3d

    restart: unless-stopped

    volumes:
      - ./squid.conf:/etc/squid/squid.conf:ro
      - squid-cache:/var/spool/squid
      - squid-logs:/var/log/squid

    # --- S√©curit√© ---
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /var/run/squid:uid=1000,gid=1000
    user: "1000:1000"

    # --- Ressources ---
    deploy:
      resources:
        limits:
          cpus: "${SQUID_CPU_LIMIT:-0.5}"
          memory: ${SQUID_MEM_LIMIT:-512M}
        reservations:
          cpus: "0.1"
          memory: 128M

    # --- Health check ---
    healthcheck:
      test: [ "CMD-SHELL", "nc -z localhost 3128 || exit 1" ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

    networks:
      - phoenix-network

    labels:
      - "com.phoenix.service=proxy"
      - "com.phoenix.profile=k3d"
      - "com.phoenix.security=whitelist-only"

  # ---------------------------------------------------------------------------
  # Prometheus ‚Äî M√©triques (k3d uniquement)
  # ---------------------------------------------------------------------------
  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: prometheus
    hostname: prometheus
    profiles:
      - k3d

    restart: unless-stopped

    ports:
      - "127.0.0.1:9090:9090"

    volumes:
      - ./config/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus

    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=${PROMETHEUS_RETENTION_DAYS:-7}d"
      - "--web.enable-lifecycle"

    security_opt:
      - no-new-privileges:true
    read_only: true
    user: "65534:65534"

    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M

    networks:
      - phoenix-network

    labels:
      - "com.phoenix.service=monitoring"
      - "com.phoenix.profile=k3d"

  # ---------------------------------------------------------------------------
  # Grafana ‚Äî Dashboards (k3d uniquement)
  # ---------------------------------------------------------------------------
  grafana:
    image: grafana/grafana:10.2.2
    container_name: grafana
    hostname: grafana
    profiles:
      - k3d

    restart: unless-stopped

    ports:
      - "127.0.0.1:3000:3000"

    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:?‚ö†Ô∏è  GRAFANA_PASSWORD est obligatoire}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=http://localhost:3000
      - GF_INSTALL_PLUGINS=grafana-clock-panel

    volumes:
      - grafana-data:/var/lib/grafana
      - ./config/grafana/provisioning:/etc/grafana/provisioning:ro

    security_opt:
      - no-new-privileges:true
    user: "472:472"

    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M

    depends_on:
      - prometheus

    networks:
      - phoenix-network

    labels:
      - "com.phoenix.service=dashboards"
      - "com.phoenix.profile=k3d"

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  phoenix-network:
    name: phoenix-network
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
    driver_opts:
      com.docker.network.bridge.enable_ip_masquerade: "true"
    labels:
      - "com.phoenix.network=internal"

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  # Phoenix
  phoenix-data:
    name: phoenix-data
    labels:
      - "com.phoenix.volume=data"
  phoenix-logs:
    name: phoenix-logs
    labels:
      - "com.phoenix.volume=logs"

  # Squid (k3d)
  squid-cache:
    name: squid-cache
    labels:
      - "com.phoenix.volume=proxy-cache"
  squid-logs:
    name: squid-logs
    labels:
      - "com.phoenix.volume=proxy-logs"

  # Monitoring (k3d)
  prometheus-data:
    name: prometheus-data
    labels:
      - "com.phoenix.volume=metrics"
  grafana-data:
    name: grafana-data
    labels:
      - "com.phoenix.volume=dashboards"

# =============================================================================
# QUICK REFERENCE
# =============================================================================
#
# 1. INSTALLATION AUTOMATIQUE (recommand√©) :
#    ./scripts/setup.sh
#
# 2. INSTALLATION MANUELLE :
#    cp .env.example .env
#    # √âditer .env (changer tokens, cl√©s API, mot de passe Grafana)
#    docker compose --profile <local|k3d|koyeb> up -d
#
# 3. V√âRIFIER L'√âTAT :
#    docker compose ps
#    curl -H "Authorization: Bearer $PHOENIX_GATEWAY_TOKEN" http://localhost:18789/health
#
# 4. AUDIT DE S√âCURIT√â :
#    docker compose exec phoenix phoenix security audit --deep
#
# 5. OLLAMA (local/k3d) :
#    ollama serve   # Dans un autre terminal sur le host
#
# 6. DEBUG :
#    docker compose --profile <profil> logs -f
#    docker compose exec phoenix sh
#
# =============================================================================
